// Prisma Schema - Sistema Gestion Inmobiliaria
// Fase 5+: Control Mensual de Pagos + Deudas + Punitorios

generator client {
  provider = "prisma-client-js"
}

// Para desarrollo local usa SQLite, para produccion usa PostgreSQL
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// MODELS
// ============================================

model User {
  id               String    @id @default(uuid())
  email            String    @unique
  passwordHash     String?   @map("password_hash")
  name             String
  globalRole       String    @default("USER") @map("global_role")
  isActive         Boolean   @default(true) @map("is_active")
  isEmailVerified  Boolean   @default(false) @map("is_email_verified")
  lastLoginAt      DateTime? @map("last_login_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Google OAuth
  googleId         String?   @unique @map("google_id")
  avatar           String?

  // Relations
  groups                  UserGroup[]
  sentInvites             GroupInvite[] @relation("InviteSender")
  refreshTokens           RefreshToken[]
  emailVerificationTokens EmailVerificationToken[]
  passwordResetTokens     PasswordResetToken[]

  @@map("users")
}

model Group {
  id            String   @id @default(uuid())
  name          String
  slug          String   @unique
  description   String?
  punitoryRate  Float    @default(0.006) @map("punitory_rate")
  currency      String   @default("ARS")

  // Company settings (Phase 6+)
  logo          String?
  companyName   String?  @map("company_name")
  address       String?
  phone         String?
  email         String?
  cuit          String?
  localidad     String?

  // Fiscal settings
  ingBrutos       String?  @map("ing_brutos")
  fechaInicioAct  String?  @map("fecha_inicio_act")
  ivaCondicion    String?  @map("iva_condicion")
  subtitulo       String?

  // Bank account (default for reports)
  bankName        String?  @map("bank_name")
  bankHolder      String?  @map("bank_holder")
  bankCuit        String?  @map("bank_cuit")
  bankAccountType String?  @map("bank_account_type")
  bankAccountNumber String? @map("bank_account_number")
  bankCbu         String?  @map("bank_cbu")
  bankAlias       String?  @map("bank_alias")

  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  members               UserGroup[]
  invites               GroupInvite[]
  categories            Category[]
  owners                Owner[]
  properties            Property[]
  tenants               Tenant[]
  contracts             Contract[]
  adjustmentIndices     AdjustmentIndex[]
  payments              Payment[]
  conceptTypes          ConceptType[]
  serviceCategories     ServiceCategory[]
  monthlyRecords        MonthlyRecord[]
  paymentTransactions   PaymentTransaction[]
  debts                 Debt[]

  @@map("groups")
}

model UserGroup {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  groupId   String   @map("group_id")
  role      String   @default("VIEWER")
  joinedAt  DateTime @default(now()) @map("joined_at")

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId])
  @@map("user_groups")
}

model GroupInvite {
  id          String    @id @default(uuid())
  groupId     String    @map("group_id")
  email       String
  role        String    @default("VIEWER")
  token       String    @unique
  status      String    @default("PENDING")
  invitedById String    @map("invited_by_id")
  expiresAt   DateTime  @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  acceptedAt  DateTime? @map("accepted_at")

  // Relations
  group       Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  invitedBy   User      @relation("InviteSender", fields: [invitedById], references: [id])

  @@map("group_invites")
}

model RefreshToken {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  token       String   @unique
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

// Email Verification Token
model EmailVerificationToken {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  token       String   @unique
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("email_verification_tokens")
}

// Password Reset Token
model PasswordResetToken {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  token       String   @unique
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")
  usedAt      DateTime? @map("used_at")

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}

// ============================================
// FASE 2: Property Management Models
// ============================================

// Category - Categorías de propiedades por grupo
model Category {
  id          String   @id @default(uuid())
  groupId     String   @map("group_id")
  name        String   // VARIOS, MATIENZO, LOCAL
  color       String?  // blue, green, orange
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  group       Group      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  properties  Property[]

  @@unique([groupId, name])
  @@map("categories")
}

// Owner - Dueños de propiedades
model Owner {
  id          String   @id @default(uuid())
  groupId     String   @map("group_id")
  name        String
  dni         String
  phone       String
  email       String?

  // Bank account (for liquidacion transfer details)
  bankName        String?  @map("bank_name")
  bankHolder      String?  @map("bank_holder")
  bankCuit        String?  @map("bank_cuit")
  bankAccountType String?  @map("bank_account_type")
  bankAccountNumber String? @map("bank_account_number")
  bankCbu         String?  @map("bank_cbu")
  bankAlias       String?  @map("bank_alias")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  group       Group      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  properties  Property[]

  @@unique([groupId, dni])
  @@map("owners")
}

// Property - Propiedades inmobiliarias
model Property {
  id              String   @id @default(uuid())
  groupId         String   @map("group_id")
  categoryId      String?  @map("category_id")
  ownerId         String?  @map("owner_id")
  address         String   // Dirección completa
  billingUnit             String?  @map("billing_unit")             // Unidad de Facturación (Agua)
  cadastralNomenclature   String?  @map("cadastral_nomenclature")   // Nomenclatura Catastral (Municipalidad)
  accountNumber           String?  @map("account_number")           // Número de Cuenta (Rentas)
  squareMeters    Float?   @map("square_meters") // m²
  rooms           Int?     // Habitaciones
  bathrooms       Int?     // Baños
  floor           String?  // Piso/Planta
  apartment       String?  // Departamento
  observations    String?  // Notas adicionales
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  group           Group      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  category        Category?  @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  owner           Owner?     @relation(fields: [ownerId], references: [id], onDelete: SetNull)
  contracts       Contract[]

  @@map("properties")
}

// ============================================
// FASE 3: Tenants & Contracts
// ============================================

// AdjustmentIndex - Índices de ajuste de alquiler
model AdjustmentIndex {
  id              String   @id @default(uuid())
  groupId         String   @map("group_id")
  name            String   // ej: "IPC Trimestral", "Índice Mensual"
  frequencyMonths Int      @map("frequency_months") // cada cuántos meses (1, 3, 4, 6, 12)
  currentValue    Float    @default(0) @map("current_value") // Porcentaje actual (ej: 15.5 = 15.5% de aumento)
  lastUpdated     DateTime? @map("last_updated") // Última vez que se actualizó el valor
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  group           Group      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  contracts       Contract[]

  @@unique([groupId, name])
  @@map("adjustment_indices")
}

// Tenant - Inquilinos
model Tenant {
  id              String   @id @default(uuid())
  groupId         String   @map("group_id")
  name            String   // Nombre completo
  dni             String   // DNI / CUIT
  phone           String?  // Teléfono
  email           String?  // Email contacto
  observations    String?  // Notas
  customerNumber  String?  @map("customer_number")   // Número de cliente
  epecContract    String?  @map("epec_contract")     // Número de Contrato (Epec)
  ecogasAccount   String?  @map("ecogas_account")    // Número de cuenta (Ecogas)
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  group           Group        @relation(fields: [groupId], references: [id], onDelete: Cascade)
  contracts       Contract[]
  contractTenants ContractTenant[]
  guarantors      Guarantor[]

  @@unique([groupId, dni])
  @@map("tenants")
}

// Guarantor - Garantes de inquilinos (hasta 5 por inquilino)
model Guarantor {
  id              String   @id @default(uuid())
  tenantId        String   @map("tenant_id")
  name            String   // Nombre completo del garante
  dni             String   // DNI / CUIT del garante
  phone           String?  // Teléfono
  email           String?  // Email
  address         String?  // Domicilio del garante
  observations    String?  // Notas
  order           Int      @default(1) // Orden (1-5)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("guarantors")
}

// Contract - Contratos de alquiler
model Contract {
  id                  String   @id @default(uuid())
  groupId             String   @map("group_id")
  tenantId            String?  @map("tenant_id")
  propertyId          String   @map("property_id")
  startDate           DateTime @map("start_date")          // Fecha inicio
  startMonth          Int      @default(1) @map("start_month") // Mes de inicio del contrato (para calcular ajustes)
  durationMonths      Int      @map("duration_months")     // Duración total en meses
  currentMonth        Int      @default(1) @map("current_month") // Mes actual (1..durationMonths)
  baseRent            Float    @map("base_rent")           // Monto alquiler mensual base
  active              Boolean  @default(true)               // true = activo, false = finalizado

  // Ajustes periódicos
  adjustmentIndexId   String?  @map("adjustment_index_id")
  nextAdjustmentMonth Int?     @map("next_adjustment_month") // Mes del contrato del próximo ajuste

  // Punitorios
  punitoryStartDay    Int      @default(4) @map("punitory_start_day")   // Día desde donde cuentan punitorios
  punitoryGraceDay    Int      @default(10) @map("punitory_grace_day")  // Día límite hábil sin punitorios
  punitoryPercent     Float    @default(0.02) @map("punitory_percent")  // % diario (0.02 = 2%)

  observations        String?
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  group               Group            @relation(fields: [groupId], references: [id], onDelete: Cascade)
  tenant              Tenant?          @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  property            Property         @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  adjustmentIndex     AdjustmentIndex? @relation(fields: [adjustmentIndexId], references: [id], onDelete: SetNull)
  contractTenants     ContractTenant[]
  payments            Payment[]
  monthlyRecords      MonthlyRecord[]
  debts               Debt[]
  rentHistory         RentHistory[]

  @@map("contracts")
}

// RentHistory - Historial de cambios de alquiler
model RentHistory {
  id                  String   @id @default(uuid())
  contractId          String   @map("contract_id")
  effectiveFromMonth  Int      @map("effective_from_month") // Mes del contrato desde el cual aplica
  rentAmount          Float    @map("rent_amount")          // Monto del alquiler en este período
  adjustmentPercent   Float?   @map("adjustment_percent")   // % de ajuste aplicado (opcional)
  reason              String?  // Motivo del cambio: "AJUSTE_AUTOMATICO", "AJUSTE_MANUAL", "INICIAL"
  appliedAt           DateTime @default(now()) @map("applied_at")
  createdAt           DateTime @default(now()) @map("created_at")

  // Relations
  contract            Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@map("rent_history")
}

// ============================================
// FASE 4: Pagos
// ============================================

model Payment {
  id             String           @id @default(uuid())
  groupId        String           @map("group_id")
  contractId     String           @map("contract_id")
  monthNumber    Int              @map("month_number")
  periodMonth    Int              @map("period_month")    // 1-12 mes de la cuota (enero=1, dic=12)
  periodYear     Int              @map("period_year")     // año de la cuota
  paymentDate    DateTime?        @map("payment_date")
  totalDue       Float            @map("total_due")
  amountPaid     Float            @default(0) @map("amount_paid")
  balance        Float            @default(0)
  status         String           @default("PENDING")
  observations   String?
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")

  group          Group            @relation(fields: [groupId], references: [id], onDelete: Cascade)
  contract       Contract         @relation(fields: [contractId], references: [id], onDelete: Cascade)
  concepts       PaymentConcept[]

  @@unique([contractId, monthNumber])
  @@map("payments")
}

model PaymentConcept {
  id             String   @id @default(uuid())
  paymentId      String   @map("payment_id")
  type           String
  description    String?
  amount         Float
  isAutomatic    Boolean  @default(false) @map("is_automatic")
  createdAt      DateTime @default(now()) @map("created_at")

  payment        Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@map("payment_concepts")
}

// Tipos de conceptos dinámicos por grupo
model ConceptType {
  id             String   @id @default(uuid())
  groupId        String   @map("group_id")
  name           String   // ej: "LUZ", "SEGURO", "PINTURA_TECHO"
  label          String   // ej: "Luz", "Seguro", "Pintura de techo"
  category       String   @default("OTROS") // Referencia a ServiceCategory.name
  description    String?  // Descripción detallada para reportes
  isDefault      Boolean  @default(false) @map("is_default")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  group          Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  monthlyServices MonthlyService[]

  @@unique([groupId, name])
  @@map("concept_types")
}

// Categorías de servicios dinámicas por grupo
model ServiceCategory {
  id        String   @id @default(uuid())
  groupId   String   @map("group_id")
  name      String   // Clave interna: IMPUESTO, SERVICIO, GASTO, MANTENIMIENTO, etc
  label     String   // Display: "Impuesto", "Servicio", "Gasto", "Mantenimiento"
  color     String   @default("badge-ghost") // Clase CSS para badge
  isDefault Boolean  @default(false) @map("is_default")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([groupId, name])
  @@map("service_categories")
}

// ============================================
// FASE 5: Control Mensual de Pagos
// ============================================

// MonthlyRecord - Fila de control mensual por contrato (se auto-genera)
model MonthlyRecord {
  id                  String    @id @default(uuid())
  groupId             String    @map("group_id")
  contractId          String    @map("contract_id")
  monthNumber         Int       @map("month_number")         // Mes del contrato (1..N)
  periodMonth         Int       @map("period_month")          // Mes calendario 1-12
  periodYear          Int       @map("period_year")           // Año calendario

  // Montos
  rentAmount          Float     @map("rent_amount")           // Valor alquiler del mes
  servicesTotal       Float     @default(0) @map("services_total") // Suma de todos los extras
  previousBalance     Float     @default(0) @map("previous_balance") // A favor (positivo) o deuda (negativo) del mes anterior
  punitoryAmount      Float     @default(0) @map("punitory_amount")  // Punitorios calculados
  punitoryDays        Int       @default(0) @map("punitory_days")
  punitoryForgiven    Boolean   @default(false) @map("punitory_forgiven")
  includeIva          Boolean   @default(false) @map("include_iva")
  ivaAmount           Float     @default(0) @map("iva_amount")
  totalDue            Float     @map("total_due")             // Alquiler + servicios + punitorios + IVA - a_favor

  // Seguimiento de pagos
  amountPaid          Float     @default(0) @map("amount_paid")
  balance             Float     @default(0)                    // amountPaid - totalDue (+ = a favor, - = debe)
  fullPaymentDate     DateTime? @map("full_payment_date")     // Fecha cuando pagó completamente

  // Estado
  status              String    @default("PENDING")           // PENDING, PARTIAL, COMPLETE
  isPaid              Boolean   @default(false) @map("is_paid")       // PAGÓ (TRUE/FALSE)
  isCancelled         Boolean   @default(false) @map("is_cancelled")  // CANCELÓ (SI/NO)

  observations        String?
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relations
  group               Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  contract            Contract  @relation(fields: [contractId], references: [id], onDelete: Cascade)
  services            MonthlyService[]
  transactions        PaymentTransaction[]
  debt                Debt?

  @@unique([contractId, monthNumber])
  @@unique([contractId, periodMonth, periodYear])
  @@map("monthly_records")
}

// MonthlyService - Servicios/extras asignados por mes/contrato
model MonthlyService {
  id                String   @id @default(uuid())
  monthlyRecordId   String   @map("monthly_record_id")
  conceptTypeId     String   @map("concept_type_id")
  amount            Float
  description       String?
  createdAt         DateTime @default(now()) @map("created_at")

  // Relations
  monthlyRecord     MonthlyRecord @relation(fields: [monthlyRecordId], references: [id], onDelete: Cascade)
  conceptType       ConceptType   @relation(fields: [conceptTypeId], references: [id], onDelete: Cascade)

  @@unique([monthlyRecordId, conceptTypeId])
  @@map("monthly_services")
}

// PaymentTransaction - Registro de cada pago real
model PaymentTransaction {
  id                String   @id @default(uuid())
  groupId           String   @map("group_id")
  monthlyRecordId   String   @map("monthly_record_id")

  paymentDate       DateTime @map("payment_date")
  amount            Float
  paymentMethod     String   @default("EFECTIVO") @map("payment_method") // EFECTIVO, TRANSFERENCIA

  // Punitorios de esta transacción
  punitoryAmount    Float    @default(0) @map("punitory_amount")
  punitoryForgiven  Boolean  @default(false) @map("punitory_forgiven")

  // Recibo
  receiptGenerated  Boolean  @default(false) @map("receipt_generated")
  receiptNumber     String?  @map("receipt_number")

  observations      String?
  createdAt         DateTime @default(now()) @map("created_at")

  // Relations
  group             Group          @relation(fields: [groupId], references: [id], onDelete: Cascade)
  monthlyRecord     MonthlyRecord  @relation(fields: [monthlyRecordId], references: [id], onDelete: Cascade)
  concepts          TransactionConcept[]

  @@map("payment_transactions")
}

// TransactionConcept - Desglose de cada transacción
model TransactionConcept {
  id                String   @id @default(uuid())
  transactionId     String   @map("transaction_id")
  type              String                                // ALQUILER, IVA, PUNITORIOS, nombre servicio, etc.
  description       String?
  amount            Float
  createdAt         DateTime @default(now()) @map("created_at")

  transaction       PaymentTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@map("transaction_concepts")
}

// Holiday - Feriados para cálculo de días hábiles
model Holiday {
  id          String   @id @default(uuid())
  date        DateTime @unique
  name        String
  year        Int
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("holidays")
}

// ============================================
// FASE 5+: Deudas y Punitorios
// ============================================

// Debt - Deuda generada al cerrar un mes con pago pendiente/parcial
model Debt {
  id                  String    @id @default(uuid())
  groupId             String    @map("group_id")
  contractId          String    @map("contract_id")
  monthlyRecordId     String    @unique @map("monthly_record_id")

  periodLabel         String    @map("period_label")          // "Noviembre 2025"
  periodMonth         Int       @map("period_month")
  periodYear          Int       @map("period_year")

  originalAmount         Float     @map("original_amount")          // Total que debía ese mes
  unpaidRentAmount       Float     @map("unpaid_rent_amount")       // Deuda post imputación servicios
  previousRecordPayment  Float     @default(0) @map("previous_record_payment") // Cuánto pagó del MonthlyRecord antes de cerrar
  accumulatedPunitory    Float     @default(0) @map("accumulated_punitory")

  currentTotal           Float     @map("current_total")            // unpaidRentAmount + punitorios - pagos
  amountPaid             Float     @default(0) @map("amount_paid")  // Pagos de la deuda (después de crearla)

  punitoryPercent     Float     @map("punitory_percent")      // % diario copiado del contrato
  punitoryStartDate   DateTime  @map("punitory_start_date")   // Desde cuándo cuentan punitorios
  lastPaymentDate     DateTime? @map("last_payment_date")

  status              String    @default("OPEN")              // OPEN, PARTIAL, PAID
  closedAt            DateTime? @map("closed_at")

  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relations
  group               Group          @relation(fields: [groupId], references: [id], onDelete: Cascade)
  contract            Contract       @relation(fields: [contractId], references: [id], onDelete: Cascade)
  monthlyRecord       MonthlyRecord  @relation(fields: [monthlyRecordId], references: [id])
  payments            DebtPayment[]

  @@map("debts")
}

// DebtPayment - Pagos parciales o totales contra una deuda
model DebtPayment {
  id                  String   @id @default(uuid())
  debtId              String   @map("debt_id")
  paymentDate         DateTime @map("payment_date")
  amount              Float
  punitoryAtPayment   Float    @default(0) @map("punitory_at_payment")
  paymentMethod       String   @default("EFECTIVO") @map("payment_method")
  observations        String?
  createdAt           DateTime @default(now()) @map("created_at")

  // Relations
  debt                Debt     @relation(fields: [debtId], references: [id], onDelete: Cascade)

  @@map("debt_payments")
}

// ============================================
// FASE 6+: Múltiples inquilinos por contrato
// ============================================

// ContractTenant - Tabla intermedia contrato-inquilino
model ContractTenant {
  id          String   @id @default(uuid())
  contractId  String   @map("contract_id")
  tenantId    String   @map("tenant_id")
  isPrimary   Boolean  @default(false) @map("is_primary")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  contract    Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([contractId, tenantId])
  @@map("contract_tenants")
}
